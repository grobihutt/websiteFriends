<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roblox Friends Search</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#2dd4bf;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,#071025 0%, #071b2a 100%);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:32px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    .container{
      width:100%;
      max-width:980px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      padding:22px;
      backdrop-filter: blur(6px);
    }
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    .search-row{display:flex;gap:10px;flex-wrap:wrap}
    input[type=text]{flex:1;min-width:220px;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--card);color:inherit;font-size:15px}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#042024;font-weight:600;cursor:pointer}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .meta{color:var(--muted);font-size:13px;margin-top:8px}

    .results{margin-top:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .card{background:var(--glass);padding:12px;border-radius:10px;display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.03)}
    .avatar{width:64px;height:64px;border-radius:8px;flex:0 0 64px;overflow:hidden;background:linear-gradient(135deg,#0f1724,#10202a);display:inline-grid;place-items:center}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .name{font-weight:600}
    .username{color:var(--muted);font-size:13px}
    .profile-link{font-size:13px;color:var(--accent);text-decoration:none}

    .center{display:flex;align-items:center;justify-content:center}
    .notice{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.02);color:var(--muted)}

    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
    .load-more{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer}
    .small{font-size:13px;color:var(--muted)}

    footer{margin-top:18px;font-size:13px;color:var(--muted)}
    @media (max-width:520px){
      .avatar{width:56px;height:56px;flex:0 0 56px}
    }
  </style>
</head>
<body>
  <main class="container" role="main">
    <header>
      <div>
        <h1>Roblox: Search user & list friends</h1>
        <div class="meta">Enter a username to fetch their friends (names + profile pictures). Uses Roblox public APIs.</div>
      </div>
    </header>

    <div class="search-row">
      <input id="usernameInput" type="text" placeholder="Roblox username e.g. Builderman" aria-label="Roblox username">
      <button id="searchBtn">Search</button>
      <button id="clearBtn" title="Clear results">Clear</button>
    </div>

    <div id="status" class="meta" style="margin-top:10px"></div>

    <section id="results" class="results" aria-live="polite"></section>

    <footer>
      <div class="small">Note: the Roblox API returns at most 100 friends per page. This tool fetches pages until there are no more or until you click "Clear".</div>
    </footer>
  </main>

  <script>
    // Helper to create elements quickly
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $('#status');
    const resultsEl = $('#results');
    const searchBtn = $('#searchBtn');
    const clearBtn = $('#clearBtn');
    const input = $('#usernameInput');

    function setStatus(text, isError=false){
      statusEl.textContent = text || '';
      statusEl.style.color = isError ? '#ffb4b4' : '';
    }

    function clearResults(){
      resultsEl.innerHTML = '';
      setStatus('');
    }

    clearBtn.addEventListener('click', ()=>{ input.value=''; clearResults(); input.focus(); });

    // Main search flow
    searchBtn.addEventListener('click', ()=>doSearch());
    input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });

    let abortController = null;

    async function doSearch(){
      const username = input.value.trim();
      if(!username){ setStatus('Please enter a username.', true); return; }

      // Abort any previous ongoing fetches
      if(abortController){ abortController.abort(); }
      abortController = new AbortController();
      const signal = abortController.signal;

      clearResults();
      setStatus('Looking up user...');
      searchBtn.disabled = true;

      try{
        // 1) Get user id from usernames endpoint (supports multiple, we supply one)
        const usersUrl = `https://users.roblox.com/v1/usernames/users?usernames=${encodeURIComponent(username)}`;
        const userResp = await fetch(usersUrl, { signal });
        if(!userResp.ok) throw new Error(`User lookup failed: ${userResp.status}`);
        const userJson = await userResp.json();
        const userData = (userJson.data && userJson.data[0]) || null;
        if(!userData){ setStatus('User not found.', true); searchBtn.disabled = false; return; }
        const userId = userData.id;
        setStatus(`Found user: ${userData.name} (ID ${userId}). Fetching friends...`);

        // 2) Fetch friends pages (friends API supports pagination). We'll loop until cursor is null or user aborts.
        let cursor = null;
        let allFriends = [];
        let page = 0;
        do{
          page++;
          setStatus(`Fetching friends â€” page ${page}...`);
          const friendsUrl = new URL(`https://friends.roblox.com/v1/users/${userId}/friends`);
          friendsUrl.searchParams.set('limit','100');
          if(cursor) friendsUrl.searchParams.set('cursor', cursor);

          const frResp = await fetch(friendsUrl.toString(), { signal });
          if(!frResp.ok) throw new Error(`Friends request failed: ${frResp.status}`);
          const frJson = await frResp.json();
          const friends = frJson.data || [];
          allFriends = allFriends.concat(friends);

          // Render incremental results so user sees progress
          renderFriends(allFriends, userId);

          cursor = frJson.nextPageCursor || frJson.nextPageCursor === 0 ? frJson.nextPageCursor : null;
          // Stop if no cursor or length less than limit
          if(!cursor) break;
          // small delay to be polite (and allow abort to propagate)
          await new Promise(r => setTimeout(r, 200));
        } while(cursor && !signal.aborted);

        if(allFriends.length === 0){ setStatus('This user has no friends or their friends are not publicly visible.'); }
        else setStatus(`Loaded ${allFriends.length} friend${allFriends.length===1?'':'s'}.`);

      }catch(err){
        if(err.name === 'AbortError'){
          setStatus('Request cancelled.');
        } else {
          console.error(err);
          setStatus('Error: '+ (err.message || err), true);
        }
      } finally {
        searchBtn.disabled = false;
      }
    }

    // Render function that requests thumbnails for friend IDs and displays cards
    async function renderFriends(friendsArray, mainUserId){
      // Clear and show header
      resultsEl.innerHTML = '';

      const header = document.createElement('div');
      header.className = 'small';
      header.textContent = `Showing ${friendsArray.length} friend${friendsArray.length===1?'':'s'}`;
      resultsEl.appendChild(header);

      if(friendsArray.length === 0){
        const notice = document.createElement('div');
        notice.className = 'notice center';
        notice.textContent = 'No friends found.';
        resultsEl.appendChild(notice);
        return;
      }

      // Create grid
      const grid = document.createElement('div');
      grid.className = 'grid';
      resultsEl.appendChild(grid);

      // Batch fetch thumbnails for up to 100 friend IDs at a time
      const ids = friendsArray.map(f => f.id).join(',');
      let thumbMap = {};
      try{
        const thumbUrl = `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${ids}&size=150x150&format=Png&isCircular=false`;
        const tResp = await fetch(thumbUrl);
        if(tResp.ok){
          const tJson = await tResp.json();
          (tJson.data || []).forEach(item => { thumbMap[item.targetId] = item.imageUrl; });
        }
      }catch(e){ console.warn('Thumbnail fetch failed', e); }

      // Build cards
      for(const friend of friendsArray){
        const card = document.createElement('article');
        card.className = 'card';

        const av = document.createElement('div'); av.className = 'avatar';
        const img = document.createElement('img');
        img.alt = `${friend.name}'s avatar`;
        img.loading = 'lazy';
        img.src = thumbMap[friend.id] || `https://www.roblox.com/headshot-thumbnail/image?userId=${friend.id}&width=150&height=150&format=png`;
        av.appendChild(img);

        const info = document.createElement('div');
        const name = document.createElement('div'); name.className = 'name'; name.textContent = friend.name;
        const uname = document.createElement('div'); uname.className = 'username'; uname.textContent = `ID: ${friend.id}`;
        const link = document.createElement('a'); link.className = 'profile-link'; link.href = `https://www.roblox.com/users/${friend.id}/profile`;
        link.target = '_blank'; link.rel = 'noopener noreferrer'; link.textContent = 'Open profile';

        info.appendChild(name);
        info.appendChild(uname);
        info.appendChild(link);

        card.appendChild(av);
        card.appendChild(info);
        grid.appendChild(card);
      }

      // Add a control to open user's main profile
      const controls = document.createElement('div'); controls.className='controls';
      const openProfile = document.createElement('a');
      openProfile.className = 'profile-link';
      openProfile.textContent = 'Open main user profile';
      openProfile.href = `https://www.roblox.com/users/${mainUserId}/profile`;
      openProfile.target = '_blank';
      controls.appendChild(openProfile);
      resultsEl.appendChild(controls);
    }

    // Small UX: autofocus the input
    input.focus();
  </script>
</body>
</html>
